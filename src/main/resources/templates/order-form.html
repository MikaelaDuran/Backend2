<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Web Shop</title>
    <link rel="stylesheet" th:href="@{/css/style.css}"/>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"/>
</head>

<body>
<!-- HEADER -->
<header>
    <!-- NAV -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <!-- Ändrar färg på NavBar -->
        <div class="container-fluid">
            <!-- Image Logo-->
            <img src="../images/logoipsum-361.svg" alt="Logo" width="50" height="50" class="d-inline-block align-text-top"/>

            <a class="navbar-brand ms-3" href="/">Fake Store API Collection</a>


            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">


                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="/">Home</a>
                    </li>

                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <!--  Dropdown Menu -->
                            Categories
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/products/all">All Products</a></li>
                            <li><a class="dropdown-item" href="/products/category/men's clothing">Mens Clothing</a></li>
                            <li><a class="dropdown-item" href="/products/category/women's clothing">Womens Clothing</a></li>
                            <li><a class="dropdown-item" href="/products/category/jewelery">Jewelery</a></li>
                            <li><a class="dropdown-item" href="/products/category/electronics">Electronics</a></li>
                        </ul>
                    </li>

                    <!--ADMIN BUTTON-->
                    <li sec:authorize="hasAuthority('ADMIN')" class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">Admin Pages</a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/orders">Orders</a></li>
                            <li><a class="dropdown-item" href="/all">Users</a></li>
                        </ul>
                    </li>

                </ul>
            </div>
        </div>
    </nav>
</header>

<br/><br/><br/><br/>

<div class="container row">
    <div id="FinalCartContainer" class="col-md-6">
        <!-- Cart items will be loaded here via JavaScript -->
    </div>

    <!-- Bootstrap form -->
    <div class="container col-md-6 fixed-col">
        <!--Price Information-->
        <div class="price-info mt-4">
            <h4>Price Summary</h4>
            <p>Subtotal: $<span id="total-price">0.00</span></p>
            <p>Shipping: $100.00</p>
            <p class="fw-bold">Total: $<span id="total-price-ship">0.00</span></p>
        </div>

        <!-- Order Form -->
        <form id="orderForm"
              th:action="@{/order-form}"
              th:object="${orderRequest}"
              method="post"
              class="container m-20">

            <!-- Hidden field for cart items JSON -->
            <input type="hidden" id="cartItemsJson" th:field="*{products}" />

            <div class="form-group">
                <label for="fullName">Full name</label>
                <input type="text"
                       class="form-control"
                       id="fullName"
                       th:field="*{fullName}"
                       placeholder="Jane Doe"/>
                <div th:if="${#fields.hasErrors('fullName')}"
                     th:errors="*{fullName}"
                     class="text-danger"></div>
                <div id="nameError" class="text-danger"></div>
                <br/>
            </div>

            <div class="form-group">
                <label for="email">Email address</label>
                <input type="email"
                       class="form-control"
                       id="email"
                       th:field="*{email}"
                       placeholder="example@email.com"/>
                <div th:if="${#fields.hasErrors('email')}"
                     th:errors="*{email}"
                     class="text-danger"></div>
                <div id="emailError" class="text-danger"></div>
                <br/>
            </div>

            <div class="form-group">
                <label for="address">Address</label>
                <input type="text"
                       class="form-control"
                       id="address"
                       th:field="*{address}"
                       placeholder="Storgatan 1"/>
                <div th:if="${#fields.hasErrors('address')}"
                     th:errors="*{address}"
                     class="text-danger"></div>
                <div id="addressError" class="text-danger"></div>
                <br/>
            </div>

            <div class="form-group">
                <label for="postalCode">Postnummer</label>
                <input type="text"
                       class="form-control"
                       id="postalCode"
                       th:field="*{postalCode}"
                       placeholder="12345"
                       title="Postal code must consist of exactly 5 digits."/>
                <div th:if="${#fields.hasErrors('postalCode')}"
                     th:errors="*{postalCode}"
                     class="text-danger"></div>
                <div id="areaCodeError" class="text-danger"></div>
                <br/>
            </div>

            <div class="form-group">
                <label for="district">District</label>
                <input type="text"
                       class="form-control"
                       id="district"
                       th:field="*{district}"
                       placeholder="Stockholm"/>
                <div th:if="${#fields.hasErrors('district')}"
                     th:errors="*{district}"
                     class="text-danger"></div>
                <div id="districtError" class="text-danger"></div>
                <br/>
            </div>

            <div class="form-group">
                <label for="mobileNumber">Mobile number</label>
                <input type="tel"
                       class="form-control"
                       id="mobileNumber"
                       th:field="*{mobileNumber}"
                       placeholder="07x-xxx xx xx"
                       title="Phone number can only contain digits (0-9), hyphens (-), and parentheses ()."/>
                <div th:if="${#fields.hasErrors('mobileNumber')}"
                     th:errors="*{mobileNumber}"
                     class="text-danger"></div>
                <div id="mobileError" class="text-danger"></div>
                <br/>
            </div>

            <div class="form-group form-check">
                <input type="checkbox"
                       class="form-check-input"
                       id="newsletter"
                       th:field="*{newsletter}"/>
                <label class="form-check-label" for="newsletter">
                    Do you want to get notify with our latest offer?
                </label>
                <br/><br/>
            </div>

            <button type="submit" class="btn btn-primary">Submit</button>
        </form>
    </div>
</div>


<script src="/js/Cart.js"></script>
<script src="/js/order-form.js"></script>
<script>

    function getCartItems() {
        try {
            return cartItems.map(item => ({
                productId: parseInt(item.id),
                quantity: item.quantity || 1
            }));
        } catch (e) {
            console.error('Error getting cart items:', e);
            return [];
        }
    }

    function submitAsJson() {
        const form = document.getElementById('orderForm');
        const formData = new FormData(form);

        // Convert form data to object
        const orderData = {};
        formData.forEach((value, key) => {
            if (key !== 'cartItemsJson') {
                // Handle checkbox values properly
                if (key === 'newsletter') {
                    orderData[key] = form.querySelector(`[name="${key}"]`).checked;
                } else {
                    orderData[key] = value;
                }
            }
        });

        // Add cart items
        orderData.products = getCartItems();

        // Submit as JSON with redirect handling
        fetch('/order-form', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(orderData),
            redirect: 'follow' // This allows automatic redirect following
        })
            .then(response => {
                if (response.redirected) {
                    // Handle redirect by navigating to the new URL
                    window.location.href = response.url;
                    return;
                }

                if (response.ok) {
                    return response.json();
                }

                // Handle validation errors or other non-redirect responses
                if (response.status === 400) {
                    return response.json().then(errorData => {
                        throw new Error(JSON.stringify(errorData));
                    });
                }

                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            })
            .then(data => {
                if (data) {
                    // Handle JSON response if not redirected
                    if (data.redirectUrl) {
                        window.location.href = data.redirectUrl;
                    } else if (data.success) {
                        window.location.href = '/order/confirmation';
                    } else {
                        console.log('Order processed:', data);
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);

                // Try to parse validation errors
                try {
                    const errorData = JSON.parse(error.message);
                    displayValidationErrors(errorData);
                } catch (e) {
                    alert('There was an error processing your order. Please try again.');
                }
            });
    }

    function displayValidationErrors(errors) {
        // Clear previous errors
        document.querySelectorAll('.text-danger').forEach(el => el.textContent = '');

        // Display new errors
        Object.keys(errors).forEach(field => {
            const errorElement = document.getElementById(`${field}Error`);
            if (errorElement) {
                errorElement.textContent = errors[field];
            }
        });
    }

    // Updated form submission handler
    document.getElementById('orderForm').addEventListener('submit', function(e) {
        e.preventDefault();

        // Validate form first
        if (!validateForm()) {
            return false;
        }

        // Check if cart is not empty
        if (cartItems.length === 0) {
            alert('Your cart is empty. Please add items before placing an order.');
            return false;
        }

        // Submit as JSON
        submitAsJson();

        return false;
    });

    window.addEventListener("DOMContentLoaded", loadInCart);
</script>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const total = parseFloat(calculateTotalPrice());
        const shipping = 100.00;
        const totalWithShipping = (total + shipping).toFixed(2);

        document.getElementById("total-price").textContent = total.toFixed(2);
        document.getElementById("total-price-ship").textContent = totalWithShipping;
    });
</script>

</body>
</html>
